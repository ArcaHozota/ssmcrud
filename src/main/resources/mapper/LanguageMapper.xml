<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.co.toshiba.ppok.mapper.LanguageMapper">
	<resultMap id="BasicResultMap"
		type="jp.co.toshiba.ppok.entity.Language" autoMapping="true">
		<id column="COUNTRY_CODE" jdbcType="NCHAR" property="countryCode" />
		<id column="LANGUAGE" jdbcType="NVARCHAR" property="language" />
	</resultMap>
	<select id="getLanguage" resultType="java.lang.String">
		SELECT DISTINCT
		    CASE 
		        WHEN SUBF.OFPERCENTAGE - SUBT.OTPERCENTAGE &gt;= 35
		            THEN SUBF.OFLANGUAGE 
		        ELSE NVL(SUBT.OTLANGUAGE, SUBF.OFLANGUAGE) 
		        END AS LANGUAGE 
		FROM
		    WORLD_LANGUAGE WL 
		    LEFT JOIN ( 
		        SELECT
		            WL.COUNTRY_CODE, 
		            WL.LANGUAGE AS OTLANGUAGE, 
		            MATX.OTPERCENTAGE 
		        FROM
		            WORLD_LANGUAGE WL 
		            INNER JOIN ( 
		                SELECT
		                    WL.COUNTRY_CODE, 
		                    MAX(WL.PERCENTAGE) AS OTPERCENTAGE 
		                FROM
		                    WORLD_LANGUAGE WL 
		                WHERE
		                    WL.LOGIC_DELETE_FLG = 'visible' 
		                    AND WL.IS_OFFICIAL = 'True' 
		                GROUP BY
		                    WL.COUNTRY_CODE
		            ) MATX 
		                ON MATX.COUNTRY_CODE = WL.COUNTRY_CODE 
		                AND MATX.OTPERCENTAGE = WL.PERCENTAGE 
		    ) SUBT 
		        ON SUBT.COUNTRY_CODE = WL.COUNTRY_CODE 
		    LEFT JOIN ( 
		        SELECT
		            WL.COUNTRY_CODE, 
		            WL.LANGUAGE AS OFLANGUAGE, 
		            MAFX.OFPERCENTAGE 
		        FROM
		            WORLD_LANGUAGE WL 
		            INNER JOIN ( 
		                SELECT
		                    WL.COUNTRY_CODE, 
		                    MAX(WL.PERCENTAGE) AS OFPERCENTAGE 
		                FROM
		                    WORLD_LANGUAGE WL 
		                WHERE
		                    WL.LOGIC_DELETE_FLG = 'visible' 
		                    AND WL.IS_OFFICIAL = 'False' 
		                GROUP BY
		                    WL.COUNTRY_CODE
		            ) MAFX 
		                ON MAFX.COUNTRY_CODE = WL.COUNTRY_CODE 
		                AND MAFX.OFPERCENTAGE = WL.PERCENTAGE 
		    ) SUBF 
		        ON SUBF.COUNTRY_CODE = WL.COUNTRY_CODE 
		WHERE
		    WL.COUNTRY_CODE = #{nationCode,jdbcType=NCHAR}
	</select>
</mapper>