<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.co.toshiba.ppok.mapper.CityMapper">
	<resultMap id="BasicResultMap"
		type="jp.co.toshiba.ppok.dto.CityDto">
		<id column="ID" jdbcType="NUMERIC" property="id" />
		<result column="NAME" jdbcType="NVARCHAR" property="name" />
		<result column="CONTINENT" jdbcType="NVARCHAR"
			property="continent" />
		<result column="NATION" jdbcType="NVARCHAR" property="nation" />
		<result column="DISTRICT" jdbcType="NVARCHAR"
			property="district" />
		<result column="POPULATION" jdbcType="NUMERIC"
			property="population" />
	</resultMap>
	<insert id="saveById"
		parameterType="jp.co.toshiba.ppok.entity.City">
		INSERT 
		INTO WORLD_CITY( 
		    NAME
		    , COUNTRY_CODE
		    , DISTRICT
		    , POPULATION
		    , LOGIC_DELETE_FLG
		) 
		VALUES ( 
		    #{name,jdbcType=NVARCHAR}
		    , #{countryCode,jdbcType=NCHAR}
		    , #{district,jdbcType=NVARCHAR}
		    , #{population,jdbcType=NUMERIC}
		    , #{logicDeleteFlg,jdbcType=NVARCHAR}
		)
	</insert>
	<update id="removeById" parameterType="java.lang.Integer">
		UPDATE WORLD_CITY CN 
		SET
		    CN.LOGIC_DELETE_FLG = 'removed' 
		WHERE
    		CN.ID = #{id,jdbcType=NUMERIC}
	</update>
	<update id="updateById"
		parameterType="jp.co.toshiba.ppok.entity.City">
		UPDATE WORLD_CITY CN
		<set>
			<if test="name != null">
				CN.NAME = #{name,jdbcType=NVARCHAR},
			</if>
			<if test="countryCode != null">
				CN.COUNTRY_CODE = #{countryCode,jdbcType=NCHAR},
			</if>
			<if test="district != null">
				CN.DISTRICT = #{district,jdbcType=NVARCHAR},
			</if>
			<if test="population != null">
				CN.POPULATION = #{population,jdbcType=NUMERIC},
			</if>
		</set>
		WHERE CN.LOGIC_DELETE_FLG = 'visible'
		AND CN.ID = #{id,jdbcType=NUMERIC}
	</update>
	<select id="getCityInfos" resultMap="BasicResultMap">
		SELECT
			SUB.ID,
			SUB.NAME,
			SUB.CONTINENT,
			SUB.NATION,
			SUB.DISTRICT,
			SUB.POPULATION
		FROM
			(
			SELECT
				ROWNUM AS ROWNO,
				WCV.ID,
				WCV.NAME,
				WCV.CONTINENT,
				WCV.NATION,
				WCV.DISTRICT,
				WCV.POPULATION
			FROM
				WORLD_CITY_VIEW WCV
			WHERE
				ROWNUM &lt;= #{pageMax,jdbcType=NUMERIC}) SUB
		WHERE
			SUB.ROWNO &gt; #{pageMin,jdbcType=NUMERIC}
	</select>
	<select id="getCityInfosCnt" resultType="java.lang.Integer">
		SELECT
			COUNT(1)
		FROM
			WORLD_CITY_VIEW WCV
	</select>
	<select id="getByNations" resultMap="BasicResultMap">
		SELECT
		    SUB.ID
		    , SUB.NAME
		    , SUB.CONTINENT
		    , SUB.NATION
		    , SUB.DISTRICT
		    , SUB.POPULATION 
		FROM
		    ( 
		        SELECT
		            ROWNUM AS ROWNO
		            , WCV.ID
		            , WCV.NAME
		            , WCV.CONTINENT
		            , WCV.NATION
		            , WCV.DISTRICT
		            , WCV.POPULATION 
		        FROM
		            WORLD_CITY_VIEW WCV 
		        WHERE
		            WCV.NATION = #{nation,jdbcType=NVARCHAR}
		            AND ROWNUM &lt;= #{pageMax,jdbcType=NUMERIC}
		    ) SUB 
		WHERE
		    SUB.ROWNO &gt; #{pageMin,jdbcType=NUMERIC}
	</select>
	<select id="getByNationsCnt" parameterType="java.lang.String"
		resultType="java.lang.Integer">
		SELECT
		    COUNT(1) 
		FROM
		    WORLD_CITY_VIEW WCV 
		WHERE
		    WCV.NATION = #{nation,jdbcType=NVARCHAR}
	</select>
	<select id="getByNames" resultMap="BasicResultMap">
		SELECT
		    SUB.ID
		    , SUB.NAME
		    , SUB.CONTINENT
		    , SUB.NATION
		    , SUB.DISTRICT
		    , SUB.POPULATION 
		FROM
		    ( 
		        SELECT
		            ROWNUM AS ROWNO
		            , WCV.ID
		            , WCV.NAME
		            , WCV.CONTINENT
		            , WCV.NATION
		            , WCV.DISTRICT
		            , WCV.POPULATION 
		        FROM
		            WORLD_CITY_VIEW WCV 
		        WHERE
		            WCV.NAME LIKE CONCAT('%', CONCAT(#{name,jdbcType=NVARCHAR}, '%')) 
		            AND ROWNUM &lt;= #{pageMax,jdbcType=NUMERIC}
		    ) SUB 
		WHERE
		    SUB.ROWNO &gt; #{pageMin,jdbcType=NUMERIC}
	</select>
	<select id="getByNamesCnt" parameterType="java.lang.String"
		resultType="java.lang.Integer">
		SELECT
		    COUNT(1)
		FROM
		    WORLD_CITY_VIEW WCV
		WHERE
		    WCV.NAME LIKE CONCAT('%', CONCAT(#{name,jdbcType=NVARCHAR}, '%'))
	</select>
	<select id="getMinimumRanks" resultMap="BasicResultMap">
		SELECT
		    WCV.ID
		    , WCV.NAME
		    , WCV.CONTINENT
		    , WCV.NATION
		    , WCV.DISTRICT
		    , WCV.POPULATION 
		FROM
		    WORLD_CITY_VIEW WCV 
		ORDER BY
		    WCV.POPULATION ASC FETCH FIRST 15 ROWS ONLY
	</select>
	<select id="getMaximumRanks" resultMap="BasicResultMap">
		SELECT
		    WCV.ID
		    , WCV.NAME
		    , WCV.CONTINENT
		    , WCV.NATION
		    , WCV.DISTRICT
		    , WCV.POPULATION 
		FROM
		    WORLD_CITY_VIEW WCV 
		ORDER BY
		    WCV.POPULATION DESC FETCH FIRST 15 ROWS ONLY
	</select>
	<select id="getCityInfoById" parameterType="java.lang.Integer"
		resultMap="BasicResultMap">
		SELECT
		    WCV.ID
		    , WCV.NAME
		    , WCV.CONTINENT
		    , WCV.NATION
		    , WCV.DISTRICT
		    , WCV.POPULATION 
		FROM
		    WORLD_CITY_VIEW WCV 
		WHERE
		    WCV.ID = #{id,jdbcType=NUMERIC}
	</select>
	<select id="checkName" parameterType="java.lang.String"
		resultType="java.lang.Integer">
		SELECT
		    COUNT(1) 
		FROM
		    WORLD_CITY CN 
		WHERE
		    CN.NAME = #{cityName,jdbcType=NVARCHAR}
	</select>
</mapper>